(()=>{"use strict";const API="https://asupanmu.aku679093.workers.dev";let all=[],activeGenre="";const PER_PAGE=10;let page=1;const POP_MIN_VIEWS=1e3,POP_MAX=10,AGE_KEY="narapoi_age_ok_v1";function lockAgeGate(){document.body.classList.add("age-locked"),document.getElementById("ageOverlay").setAttribute("aria-hidden","false")}function unlockAgeGate(){document.body.classList.remove("age-locked"),document.getElementById("ageOverlay").setAttribute("aria-hidden","true")}(()=>{localStorage.getItem(AGE_KEY)==="1"||lockAgeGate(),document.getElementById("ageYes").onclick=(()=>{localStorage.setItem(AGE_KEY,"1"),unlockAgeGate()}),document.getElementById("ageNo").onclick=(()=>{location.href="about:blank"})})();const ANON_ID_KEY="narapoi_anon_id_v1";function ensureAnonId(){let e=localStorage.getItem(ANON_ID_KEY);return e||(e="u-"+Math.random().toString(36).slice(2,10)+Math.random().toString(36).slice(2,6),localStorage.setItem(ANON_ID_KEY,e)),document.getElementById("anonIdPill").textContent=e,e}function escapeHtml(e){return String(e).replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[e])))}function fmtDuration(e){const t=Number(e);if(!Number.isFinite(t)||t<=0)return"--:--";const n=Math.floor(t/60),o=Math.floor(t%60).toString().padStart(2,"0");return`${n}:${o}`}function cardHTML(e){const t=(e.kind||"link").toUpperCase(),n=e.created_at?new Date(e.created_at).toLocaleDateString():"",o=e.genre?e.genre:"",a=e.views??0;return`\n        <div class="thumb">\n          ${e.thumb_url?`<img loading="lazy" src="${e.thumb_url}" alt="">`:`<img loading="lazy" alt="">`}\n          <div class="badges">\n            <span class="badge accent">HD</span>\n            <span class="badge">${escapeHtml(t)}</span>\n            ${o?`<span class="badge">${escapeHtml(o)}</span>`:""}\n          </div>\n          <div class="duration">${fmtDuration(e.duration)}</div>\n        </div>\n        <div class="body">\n          <p class="title">${escapeHtml(e.title||"Untitled")}</p>\n          <div class="meta">\n            <span>${n||"Today"}</span>\n            <span style="opacity:.5">•</span>\n            <span>Views: ${a}</span>\n          </div>\n        </div>\n      `}function splitGenres(e){return String(e||"").split(",").map((e=>e.trim())).filter(Boolean)}function shufflePick(e){return e&&e.length?e[Math.floor(Math.random()*e.length)]:null}function getFilteredList(){const e=document.getElementById("q").value.toLowerCase().trim();let t=all;return activeGenre&&(t=t.filter((e=>splitGenres(e.genre).includes(activeGenre)))),e&&(t=t.filter((t=>(t.title||"").toLowerCase().includes(e)))),t}function renderPopular(){const e=document.getElementById("popularHead"),t=document.getElementById("popWrap"),n=document.getElementById("popularRow");n.innerHTML="";const o=all.filter((e=>Number(e.views||0)>=POP_MIN_VIEWS)).slice().sort(((e,t)=>Number(t.views||0)-Number(e.views||0))).slice(0,POP_MAX);if(!o.length)return e.style.display="none",void(t.style.display="none");e.style.display="flex",t.style.display="block",o.forEach((e=>{const t=document.createElement("a");t.className="card anim popCard",t.href="player.html?id="+encodeURIComponent(e.id),t.innerHTML=cardHTML(e),n.appendChild(t),requestAnimationFrame((()=>t.classList.add("show")))}));const a=document.getElementById("popPrev"),i=document.getElementById("popNext"),d=document.getElementById("popFadeL"),r=document.getElementById("popFadeR"),c=e=>{const t=n.querySelector(".popCard"),o=t?t.getBoundingClientRect().width:180;n.scrollBy({left:e*(o+10),behavior:"smooth"})};a.onclick=(()=>c(-1)),i.onclick=(()=>c(1));const s=()=>{const e=n.scrollWidth-n.clientWidth,t=n.scrollLeft,o=n.scrollWidth>n.clientWidth+5;a.classList.toggle("hide",!o),i.classList.toggle("hide",!o),d.style.opacity=o&&t>2?"1":"0",r.style.opacity=o&&t<e-2?"1":"0"};s(),n.addEventListener("scroll",s,{passive:!0}),window.addEventListener("resize",s)}function openGenreModal(e){const t=document.getElementById("genreOverlay"),n=document.getElementById("genreAllWrap");n.innerHTML="",e.forEach((e=>{const o=document.createElement("span");o.className="chip"+(activeGenre===e?" active":""),o.textContent=e,o.onclick=(()=>{activeGenre=e,page=1,apply(),renderChips(t.__ALL_GENRES__||t.__LAST_GENRES__||e),closeGenreModal()}),n.appendChild(o)})),t.classList.add("show"),t.setAttribute("aria-hidden","false"),document.getElementById("genreClose").onclick=closeGenreModal,t.onclick=(e=>{e.target===t&&closeGenreModal()}),window.addEventListener("keydown",(function e(n){n.key==="Escape"&&(closeGenreModal(),window.removeEventListener("keydown",e))}))}function closeGenreModal(){const e=document.getElementById("genreOverlay");e.classList.remove("show"),e.setAttribute("aria-hidden","true")}function renderChips(e){const t=document.getElementById("chips");t.innerHTML="";const n=(n,o,a)=>{const i=document.createElement("span");return i.className="chip"+(activeGenre===o?" active":""),i.textContent=n,i.onclick=a||(()=>{activeGenre=o,page=1,apply(),renderChips(e)}),i};t.appendChild(n("Semua","")),t.appendChild(n("Klik untuk menonton acak","__RANDOM__",(()=>{const e=getFilteredList(),t=shufflePick(e);t&&(location.href="player.html?id="+encodeURIComponent(t.id))})));const o=12,a=e.slice(0,o),i=e.slice(o);a.forEach((e=>t.appendChild(n(e,e)))),i.length&&t.appendChild(n("•••","__MORE__",(()=>openGenreModal(e))))}function renderPager(e){const t=document.getElementById("pager"),n=document.getElementById("prevBtn"),o=document.getElementById("nextBtn"),a=document.getElementById("pagerInfo");t.style.display=e>1?"flex":"none",a.textContent=`Page ${page} / ${e}`,n.disabled=page<=1,o.disabled=page>=e,n.onclick=(()=>{page>1&&(page-=1,apply(!0),window.scrollTo({top:0,behavior:"smooth"}))}),o.onclick=(()=>{page<e&&(page+=1,apply(!0),window.scrollTo({top:0,behavior:"smooth"}))})}function renderList(e,t){const n=document.getElementById("grid"),o=document.getElementById("empty");n.innerHTML="",e.length?(o.style.display="none",e.forEach((e=>{const t=document.createElement("a");t.className="card anim",t.href="player.html?id="+encodeURIComponent(e.id),t.innerHTML=cardHTML(e),n.appendChild(t),requestAnimationFrame((()=>t.classList.add("show")))})),renderPager(t)):(o.style.display="block",renderPager(1))}function apply(){const e=getFilteredList(),t=Math.max(1,Math.ceil(e.length/PER_PAGE));page>t&&(page=t),page<1&&(page=1);const n=(page-1)*PER_PAGE;renderList(e.slice(n,n+PER_PAGE),t)}const HIST_KEY="narapoi_watch_history_v1";function safeParse(e,t){try{return JSON.parse(e)}catch{return t}}function loadHistory(){const e=safeParse(localStorage.getItem(HIST_KEY)||"[]",[]),t=e.slice(0,50);return t.length!==e.length&&localStorage.setItem(HIST_KEY,JSON.stringify(t)),t}function renderProfile(){ensureAnonId();const e=document.getElementById("profileList"),t=document.getElementById("profileEmpty");e.innerHTML="";const n=loadHistory();return n.length?(t.style.display="none",void n.forEach((t=>{const n=document.createElement("a");n.className="miniItem",n.href="player.html?id="+encodeURIComponent(t.id),n.innerHTML=`\n          <div class="miniThumb">\n            ${t.thumb_url?`<img loading="lazy" src="${t.thumb_url}" alt="">`:`<img loading="lazy" alt="">`}\n          </div>\n          <div style="min-width:0;flex:1">\n            <p class="miniTitle">${escapeHtml(t.title||"Untitled")}</p>\n            <div class="miniMeta">${t.ts?new Date(t.ts).toLocaleString():""}</div>\n          </div>\n        `,e.appendChild(n)}))):(t.style.display="block",void 0)}const views={home:document.getElementById("viewHome"),support:document.getElementById("viewSupport"),profile:document.getElementById("viewProfile")},navs={home:document.getElementById("navHome"),support:document.getElementById("navSupport"),profile:document.getElementById("navProfile")};function setActiveView(e){Object.keys(views).forEach((t=>views[t].classList.toggle("show",t===e))),Object.keys(navs).forEach((t=>navs[t].classList.toggle("active",t===e))),e==="home"&&apply(),e==="profile"&&renderProfile()}navs.home.onclick=(()=>setActiveView("home")),navs.support.onclick=(()=>setActiveView("support")),navs.profile.onclick=(()=>setActiveView("profile")),document.getElementById("btnReport").onclick=(()=>{location.href="narapoiofc@haren.uk"}),document.getElementById("btnDonate").onclick=(()=>{location.href="https://saweria.co/Narapoi"}),document.getElementById("btnReqUpdate").onclick=(()=>{location.href="https://saweria.co/Narapoi"});async function load(){const e=await fetch(API+"/api/videos",{cache:"no-store"}),t=await e.json();all=t.videos||[],renderPopular();const n=[...new Set(all.flatMap((e=>splitGenres(e.genre))))].sort();renderChips(n);const o=navs.support.classList.contains("active")?"support":navs.profile.classList.contains("active")?"profile":"home";o==="home"&&apply(),o==="profile"&&renderProfile()}document.getElementById("reload").onclick=(()=>load()),document.getElementById("q").addEventListener("input",(()=>{page=1,navs.home.classList.contains("active")&&apply()})),ensureAnonId(),load()})();
